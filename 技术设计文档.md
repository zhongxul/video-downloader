# 安卓本地视频下载 App 技术设计文档（当前实现）

> 文档版本：v1.1.0  
> 最后更新：2026-02-10

## 1. 技术栈
- 语言与 UI：Kotlin + Jetpack Compose
- 架构：MVVM + UseCase + Repository
- 存储：Room
- 网络：OkHttp
- 下载：Android DownloadManager + 内部 m3u8 分片下载
- X 解析回退：yt-dlp-android

## 2. 模块划分
- `ui/`：Compose 页面、状态展示、交互
- `domain/`：模型与用例（解析、建任务、状态同步、重试）
- `data/`：Room 实体、DAO、Repository
- `parser/`：WebParser + YtDlpParser + Hybrid 聚合
- `download/`：下载网关、预检、结果校验、媒体库扫描
- `di/`：`AppContainer` 手工依赖注入

## 3. 核心流程
### 3.1 解析流程
入口：`HomeViewModel.parseLink()`
1. `ParseLinkUseCase` 从输入文案提取 URL。
2. X 链接先经 `XCookieValidator` 预校验。
3. `HybridParserGateway` 先走 Web 解析，失败再走 yt-dlp。
4. `HomeViewModel.enrichFormatMeta()` 做格式增强：
   - m3u8 变体解析（尝试读取 master playlist 的分辨率/码率）。
   - mp4 大小轻量探测（Range/Content-Length）。
   - 推荐项判定与置顶（满足触发条件时）。

### 3.2 推荐排序规则
- 不触发：格式数量 `<= 1`。
- 触发条件：格式数量 `> 1` 且至少一个格式存在质量特征。
- 评分因子：分辨率高度、码率、文件大小。
- 无可用质量信息：保持原顺序。

### 3.3 下载流程
入口：`CreateDownloadTaskUseCase`
1. 解析选项通过可下载性校验。
2. 调用 `DownloadGateway.startDownload()` 开始任务。
3. 网关层先做同名去重，回传最终文件名。
4. 用例层回写任务标题（使用最终文件名去后缀），避免历史重名歧义。

### 3.4 状态同步与落盘校验
入口：`SyncDownloadStatusUseCase`
- 周期同步 DownloadManager 状态。
- 对成功结果进行文件有效性校验。
- 异常（空文件、m3u8 文本、HTML/JSON、容器异常）自动转失败并删除。
- 失败时尽量保留失败前最后进度，用于 UI 展示。

## 4. m3u8 设计说明
- `m3u8` 本质是播放清单，解析阶段通常拿不到最终合并文件大小。
- 展示策略：
  - 可获取分辨率/码率时展示对应信息。
  - 无法获取时展示“分片流 · 最终大小以下载后为准”。
- 交互策略：无质量信息的分片流提供“预览”按钮，调用外部播放器/浏览器打开。

## 5. 历史页交互设计
- 解析记录与下载队列在同卡片切换。
- 管理模式支持：全选/取消全选、删除、分享。
- 支持长按记录直接进入管理并选中。
- 下载队列条目采用固定三段布局，避免长文本撑高。

## 6. 数据模型
### 6.1 DownloadTask
关键字段：
- `id, sourceUrl, downloadUrl, title`
- `selectedFormatId, selectedResolution, selectedExt`
- `status, progress, saveUri, errorMessage`
- `externalDownloadId, retryFromTaskId`

### 6.2 ParseRecord
关键字段：
- `rawInput, resolvedUrl, title, status, message`
- `selectedFormatLabel, selectedExt, taskId`

## 7. 关键实现文件
- 解析增强与推荐：`app/src/main/java/com/example/videodownloader/ui/screen/home/HomeViewModel.kt`
- 格式卡片与预览交互：`app/src/main/java/com/example/videodownloader/ui/screen/home/HomeScreen.kt`
- 下载网关与同名去重：`app/src/main/java/com/example/videodownloader/download/AndroidDownloadGateway.kt`
- 任务创建/重试/继续：
  - `app/src/main/java/com/example/videodownloader/domain/usecase/CreateDownloadTaskUseCase.kt`
  - `app/src/main/java/com/example/videodownloader/domain/usecase/RetryDownloadTaskUseCase.kt`
  - `app/src/main/java/com/example/videodownloader/domain/usecase/ResumeDownloadTaskUseCase.kt`
- 状态同步：`app/src/main/java/com/example/videodownloader/domain/usecase/SyncDownloadStatusUseCase.kt`

## 8. 已知限制
- 部分站点/CDN 不返回可用头信息，大小可能长期未知。
- X 平台受 Cookie、地区、节点质量影响较大。
- m3u8 预览效果依赖用户设备上可用播放器能力。

## 9. 构建命令
```powershell
.\环境一键配置.ps1
.\gradlew.bat :app:assembleDebug
```

## 变更记录
- 2026-02-10 16:39 v1.0.0：重写为“当前实现版”，梳理架构、流程、模型与异常策略
- 2026-02-10 22:40 v1.1.0：补充推荐排序触发规则、m3u8 预览策略、同名下载重命名与标题回写
