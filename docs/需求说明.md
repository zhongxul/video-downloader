# 安卓本地视频下载 App 需求说明（当前基线）

> 文档版本：v1.3.0  
> 最后更新：2026-02-14

## 1. 目标
- 面向个人自用场景，提供抖音、X 与 kstore hash 链接解析、本地下载与历史管理。
- 不依赖自建后端，不依赖额外设备，数据仅存本机。
- 重点保证：可解析、可下载、可播放、可定位失败原因。

## 2. 范围
### 2.1 在范围内
- 链接/分享文案输入与 URL 提取。
- 抖音与 X 链接解析、可下载格式展示。
- `kstore.vip/*.html#...`（如 `bluegay/xgaymv`）hash 解码解析。
- 下载任务创建、状态同步、失败重试。
- 普通 m3u8 下载与 `AES-128` 加密 m3u8 下载。
- 解析记录与下载队列管理（含批量操作）。
- 已完成页管理（全选、长按进入管理并选中）。
- X Cookie 手动与网页登录回填。
- 下载结果有效性校验与异常文件自动清理。

### 2.2 不在范围内
- 云端账号与多端同步。
- iOS 支持。
- 面向上架的商业化流程。
- 非 `AES-128` 的加密 m3u8（如 `SAMPLE-AES`）。

## 3. 核心功能需求
### 3.1 解析与格式展示
- 支持从抖音分享长文本中提取真实链接。
- 支持 `kstore.vip/*.html#...` 变体 Base64 hash 解码并提取真实媒体地址。
- 解析结果至少展示：分辨率/扩展名、可下载性。
- 可获取时展示：时长、大小、码率。

### 3.2 下载与文件管理
- 创建任务后进入下载队列，支持重试与取消。
- 下载队列卡片显示进度条与百分比。
- 同名文件自动重命名：`标题(1)`、`标题(2)`…
- 下载成功后文件可被系统媒体库识别。
- 异常结果自动判失败并删除，不进入“已完成”。

### 3.3 m3u8 行为
- 普通 m3u8：分片并发下载、顺序写入合并。
- 加密 m3u8：支持 `#EXT-X-KEY` 且 `METHOD=AES-128`。
- key 下载失败、IV 非法、解密失败需返回可读错误。

### 3.4 历史管理
- 历史页包含解析记录与下载队列切换。
- 管理模式支持：多选、全选、删除、分享。
- 支持长按记录直接进入管理并选中。
- 已完成页管理模式支持全选/取消全选。

## 4. 非功能需求
- 稳定性：网络波动时不崩溃，并提供可读错误提示。
- 可维护性：业务规则集中在 UseCase/Gateway，UI 不写数据一致性逻辑。
- 隐私：Cookie 与历史仅本地保存，不上传服务器。
- 性能：m3u8 下载需支持受控并发、连接复用与退避重试。

## 5. 验收基线
- 抖音链接可稳定解析并下载。
- X 普通视频在 Cookie 有效时可解析并下载。
- `kstore.vip/*.html#...` 链接可解析出真实下载地址。
- `AES-128` 加密 m3u8 可下载并播放。
- 下载队列卡片显示进度条。
- 已完成页管理模式支持全选，且可长按条目进入管理并自动选中。

## 变更记录
- 2026-02-10 v1.0.0：按当时实现重写需求基线，明确范围与验收边界
- 2026-02-10 v1.1.0：新增 m3u8 预览、推荐触发条件、同名重命名
- 2026-02-14 v1.2.0：新增 m3u8 下载性能优化相关需求与验收项
- 2026-02-14 v1.3.0：新增 kstore hash 链接解析、AES-128 加密 m3u8 下载、历史页交互增强
