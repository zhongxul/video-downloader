# 项目维护手册

> 文档版本：v1.3.0  
> 最后更新：2026-02-14

## 1. 手册定位
本手册用于维护阶段的“怎么排障、怎么回归、怎么发布”，与需求/设计文档配套使用。

## 2. 维护入口
- 需求基线：`docs/需求说明.md`
- 技术设计：`docs/技术设计文档.md`
- 启动运行：`docs/启动说明.md`
- 回归用例：`docs/失败场景回归测试清单.md`
- 专项调研：`docs/bluegay链接解析调研.md`

## 3. 常见改动优先级
1. 先改 `parser/` 或 `download/` 业务逻辑。
2. 再改 `domain/usecase/` 的状态编排。
3. 最后改 `ui/` 提示与交互。

## 4. 关键排障路径
### 4.1 解析异常
- 查看 `ParseLinkUseCase`、`WebParserGateway`、`YtDlpParserGateway` 日志。
- X 相关先检查 Cookie：`auth_token`、`ct0`。
- kstore 链接先确认 hash 可正常解码为 JSON。

### 4.2 下载异常
- 查看 `AndroidDownloadGateway` 预检、分片重试、落盘校验日志。
- 若为加密 m3u8，重点检查：
  - `#EXT-X-KEY` 的 `METHOD/URI/IV` 是否解析成功
  - key 拉取是否 200
  - 是否触发 `unsupported m3u8 key method`
- 若反馈“成功但不可播放”，优先确认是否被有效性校验判失败并删除。

### 4.3 UI 交互异常
- 下载队列进度展示：`HistoryScreen`（`LinearProgressIndicator`）。
- 已完成页管理交互：`CompletedScreen` + `CompletedViewModel`（全选、长按进入管理）。

## 5. 回归最小集
每次涉及解析/下载改动至少执行：
- 抖音文案解析 1 条 + 下载 1 条
- X 普通视频（Cookie 有效）1 条
- kstore hash 链接（`bluegay` 或 `xgaymv`）1 条
- AES-128 m3u8 1 条，验证 key + 分片解密
- 非 AES-128 m3u8 1 条，验证不支持提示
- 同标题重复下载 2 次，验证 `(1)` 命名

## 6. 构建与发布
```powershell
.\环境一键配置.ps1
.\gradlew.bat :app:assembleDebug
```

APK：`app/build/outputs/apk/debug/app-debug.apk`

## 7. 清理策略
可安全清理（可再生）：
- `app/build/`
- 临时目录（若存在）

不建议频繁清理：
- `.gradle/`（会导致依赖重复下载）
- `.idea/`（IDE 工程配置）

## 8. 近期变更（维护关注）
- 新增 `kstore.vip/*.html#...` hash 解码解析。
- 新增加密 m3u8 `AES-128` 下载支持（key 拉取 + 分片解密合并）。
- 下载队列卡片改为进度条展示。
- 已完成页补全“全选/取消全选”并支持长按进入管理。

## 变更记录
- 2026-02-10 v1.0.0：建立维护手册并补充清理策略与故障定位路径
- 2026-02-10 v1.1.0：重写维护手册并对齐当前行为
- 2026-02-14 v1.2.0：补充 m3u8 提速后的维护排障重点与最小回归集
- 2026-02-14 v1.3.0：补充 kstore hash 与 AES-128 下载维护要点、UI 交互排障项
