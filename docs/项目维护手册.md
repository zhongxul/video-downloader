# 项目维护手册

> 文档版本：v1.1.0  
> 最后更新：2026-02-10

## 1. 手册定位
本手册用于维护阶段的“怎么排障、怎么回归、怎么发布”，与需求/设计文档配套使用。

## 2. 维护入口
- 需求基线：`需求说明.md`
- 技术设计：`技术设计文档.md`
- 启动运行：`启动说明.md`
- 回归用例：`失败场景回归测试清单.md`

## 3. 常见改动优先级
1. 先改 `parser/` 或 `download/` 业务逻辑。
2. 再改 `domain/usecase/` 的状态编排。
3. 最后改 `ui/` 提示与交互。

## 4. 关键排障路径
### 4.1 解析异常
- 查看 `ParseLinkUseCase`、`WebParserGateway`、`YtDlpParserGateway` 日志。
- X 相关先检查 Cookie：`auth_token`、`ct0`。
- m3u8 相关检查是否拿到 master playlist（`#EXT-X-STREAM-INF`）。

### 4.2 下载异常
- 查看 `AndroidDownloadGateway` 预检、分片重试、落盘校验日志。
- 如果“成功但不可播放”，优先确认是否被同步用例判为异常并已删除。
- 关注 `SyncDownloadStatusUseCase` 对失败进度与状态回写是否正确。

### 4.3 命名与历史
- 同名重命名逻辑在 `AndroidDownloadGateway.ensureUniqueFileName`。
- 标题回写逻辑在 `Create/Retry/ResumeDownloadTaskUseCase`。

## 5. 回归最小集
每次涉及解析/下载改动至少执行：
- 抖音文案解析 1 条 + 下载 1 条
- X 普通视频（Cookie 有效）1 条
- X m3u8（有质量信息）1 条
- X m3u8（无质量信息）1 条，验证“预览”按钮
- 同标题重复下载 2 次，验证 `(1)` 命名

## 6. 构建与发布
```powershell
.\环境一键配置.ps1
.\gradlew.bat :app:assembleDebug
```

APK：`app/build/outputs/apk/debug/app-debug.apk`

## 7. 清理策略
可安全清理（可再生）：
- `app/build/`
- 临时目录（若存在）

不建议频繁清理：
- `.gradle/`（会导致依赖重复下载）
- `.idea/`（IDE 工程配置）

## 8. 近期变更（维护关注）
- 推荐排序仅在“多选项 + 有可判断信息”时触发。
- m3u8 无质量信息时支持“预览”。
- 同名下载自动重命名并回写任务标题。
- 历史页管理模式支持长按进入、整行选择、全选。

## 变更记录
- 2026-02-10 16:39 v1.0.0：建立维护手册并补充清理策略与故障定位路径
- 2026-02-10 22:40 v1.1.0：重写维护手册并对齐当前行为
