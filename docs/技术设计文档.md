# 安卓本地视频下载 App 技术设计文档（当前实现）

> 文档版本：v1.3.1  
> 最后更新：2026-02-14

## 1. 技术栈
- 语言与 UI：Kotlin + Jetpack Compose
- 架构：MVVM + UseCase + Repository
- 存储：Room
- 网络：OkHttp
- 下载：Android DownloadManager + 内部 m3u8 分片下载
- X 解析回退：yt-dlp-android

## 2. 模块划分
- `ui/`：Compose 页面、状态展示、交互
- `domain/`：模型与用例（解析、建任务、状态同步、重试）
- `data/`：Room 实体、DAO、Repository
- `parser/`：WebParser + YtDlpParser + Hybrid 聚合
- `download/`：下载网关、预检、结果校验、媒体库扫描
- `di/`：`AppContainer` 手工依赖注入

## 3. 核心流程
### 3.1 解析流程
入口：`HomeViewModel.parseLink()`
1. `ParseLinkUseCase` 从输入文案提取 URL。
2. X 链接先经 `XCookieValidator` 预校验。
3. `HybridParserGateway` 先走 Web 解析，失败再走 yt-dlp。
4. Web 解析中优先尝试 kstore hash 页面解码（`kstore.vip/*.html#...`）。

### 3.2 kstore hash 链接解析
实现：`WebParserGateway.parseBlueGayHash()`
- 识别规则：URL 含 `kstore.vip/` 且含 `.html#`。
- hash 解码规则：`- -> +`、`_ -> /`、`. -> =` 后做 Base64 解码。
- 解析 JSON 得到 `title/url`，并生成可下载 `VideoFormat`（`mp4/m3u8`）。

### 3.3 X 解析提速策略
实现：`WebParserGateway.parseXFast()`
- `status` 链接：并行发起 `syndication + fx`，先返回者即命中。
- `broadcast` 链接：优先 `broadcast`，失败再做轻量 meta 兜底。
- FX 镜像：`fxtwitter/vxtwitter/fixupx` 并行探测，避免串行等待。
- X 请求单独短超时客户端，降低慢链路等待成本。

### 3.4 下载流程
入口：`CreateDownloadTaskUseCase`
1. 解析选项通过可下载性校验。
2. 调用 `DownloadGateway.startDownload()` 开始任务。
3. 网关层先做同名去重，回传最终文件名。
4. 用例层回写任务标题（使用最终文件名去后缀），避免历史重名歧义。

### 3.5 m3u8 下载流程
实现：`AndroidDownloadGateway`
1. 解析 playlist（master/media）并抽取分片。
2. 若存在 `#EXT-X-KEY`：
   - 解析 `METHOD/URI/IV`
   - 当前仅接受 `METHOD=AES-128`
   - 先下载 key，再按分片逐个解密
3. 分片下载采用有限窗口并发，写入时保持顺序。
4. 合并后执行结果有效性校验，不合格则删除并标记失败。

## 4. 可观测性
- X 解析新增分支耗时日志：
  - `parseXFast success/fail cost=...`
  - `parseXStatusFast branch=... hit=... cost=...`
  - `parseTwitterFx mirror=... hit=... cost=...`

## 5. UI 交互设计（历史页）
- 下载队列：状态文案下方增加 `LinearProgressIndicator` 进度条。
- 已完成页：
  - 管理模式新增“全选/取消全选”
  - 支持长按任意条目直接进入管理并选中该条目

## 6. 数据模型
### 5.1 DownloadTask
关键字段：
- `id, sourceUrl, downloadUrl, title`
- `selectedFormatId, selectedResolution, selectedExt`
- `status, progress, saveUri, errorMessage`
- `externalDownloadId, retryFromTaskId`

### 5.2 ParseRecord
关键字段：
- `rawInput, resolvedUrl, title, status, message`
- `selectedFormatLabel, selectedExt, taskId`

## 7. 关键实现文件
- kstore hash 解析：`app/src/main/java/com/example/videodownloader/parser/WebParserGateway.kt`
- m3u8 下载与 AES-128 解密：`app/src/main/java/com/example/videodownloader/download/AndroidDownloadGateway.kt`
- 下载队列进度条：`app/src/main/java/com/example/videodownloader/ui/screen/history/HistoryScreen.kt`
- 已完成页管理增强：`app/src/main/java/com/example/videodownloader/ui/screen/history/CompletedScreen.kt`
- 已完成页管理状态：`app/src/main/java/com/example/videodownloader/ui/screen/history/CompletedViewModel.kt`

## 8. 已知限制
- 非 `AES-128` 的加密方式（如 `SAMPLE-AES`）不支持。
- 链接 `auth_key` 过期后会下载失败，需使用新链接。
- X 平台受 Cookie、地区、节点质量影响较大。

## 9. 构建命令
```powershell
.\环境一键配置.ps1
.\gradlew.bat :app:assembleDebug
```

## 变更记录
- 2026-02-10 v1.0.0：重写为“当前实现版”，梳理架构、流程、模型与异常策略
- 2026-02-10 v1.1.0：补充推荐排序触发规则、m3u8 预览策略、同名下载重命名与标题回写
- 2026-02-14 v1.2.0：补充 m3u8 下载提速实现细节
- 2026-02-14 v1.3.0：补充 kstore hash 解析、AES-128 解密下载、历史页交互改造
- 2026-02-14 v1.3.1：补充 X 解析并行提速与耗时日志设计
